<?php
include("pChart/pData.class");
include("pChart/pChart.class");

class cView{
  private $model;

 //-----------------------------------------------------------------------------------------------
  public function __construct($model) {
    $this->model = $model;
  }
 
//-----------------------------------------------------------------------------------------------
public function draw_pie_chart($field_name, $pieDataIn, $chart)
{
 $pieData = $pieDataIn;
 $fields = array();
 $count = array();
 
for($i=0; $i < count($pieData); $i++){
    $fields[] = $pieData[$i][0];
    $count[] = $pieData[$i][1];
}
 
  $DataSet = new pData;
  $DataSet->AddPoint($fields,$field_name);
  $DataSet->AddPoint($count,"Count");
  $DataSet->AddAllSeries();
  $DataSet->SetAbsciseLabelSerie($field_name);

if($chart=='Chart1'){
  $Chart1 = new pChart(360,210);
  $Chart1->loadColorPalette("pallete/softones.txt");
  $Chart1->drawFilledRoundedRectangle(7,7,357,207,5,240,240,240);  
  $Chart1->drawRoundedRectangle(5,5,360,210,5,230,230,230);  

  
  $Chart1->drawFilledCircle(122,102,70,200,200,200);  

  
  $Chart1->setFontProperties("Fonts/tahoma.ttf",8);
  $getData = $DataSet->GetData();
  $getDataDescription = $DataSet->GetDataDescription();
  
  $Chart1->drawBasicPieGraph($getData,$getDataDescription,120,100,70,PIE_PERCENTAGE,255,255,218);  
  $Chart1->drawPieLegend(230,15,$getData,$getDataDescription,250,250,250); 

  $Chart1->Render("charts/$field_name.png");
  
  }
  
 
if($chart=='Chart2'){
 $Chart2 = new pChart(420,200);  
 $Chart2->drawFilledRoundedRectangle(7,7,413,193,5,240,240,240);  
 $Chart2->drawRoundedRectangle(5,5,415,195,5,230,230,230);  
  
 $getData = $DataSet->GetData();
 $getDataDescription = $DataSet->GetDataDescription();
 $Chart2->setFontProperties("Fonts/tahoma.ttf",8);  
 $Chart2->drawPieGraph($getData,$getDataDescription,150,90,110,PIE_PERCENTAGE,TRUE,50,20,5);  
 $Chart2->drawPieLegend(310,15,$getData,$getDataDescription,250,250,250);  
 $Chart2->Render("charts/$field_name.png");
 
 } 
  
  echo "<img src=\"./charts/$field_name.png\">";
  return 0;
}

//-----------------------------------------------------------------------------------------------
public function print_stats($field ,$add_links=false)
{
	
	
	$data_array = $this->model->get_stat_data($field);
	
   if($add_links){
	  echo '<table class="table table-condensed" >
  <thead>
  <tr>
	  <th>'.$field.'</th>
	  <th>Count</th>
	  <th>Percent</th>
  </tr>
  </thead>
  <tbody class="panel-group panel" id="accordion">';
	foreach ($data_array as $data){
	 
	echo '<tr>';
    echo '<td><a href="#'. $data[$field] . '" data-toggle="collapse" data-parent="#accordion">' . $data[$field] . '</a></td>';
    echo '<td>' . $data['count'] . '</td>';
	echo '<td>' . $data['percent'] . '</td>';
	echo '</tr>';
		
	$pieData[] = array($data[$field], $data['count']);
	}
  } else {
	  
	   echo '<table class="table table-condensed">
  <thead>
  <tr>
	  <th>'.$field.'</th>
	  <th>Count</th>
	  <th>Percent</th>
  </tr>
  </thead>
  <tbody>';
  
  foreach ($data_array as $data){
    echo '<tr>';
	echo '<td>' . $data[$field] . '</td>';
    echo '<td>' . $data['count'] . '</td>';
	echo '<td>' . $data['percent'] . '</td>';
	echo '</tr>';
	$pieData[] = array($data[$field], $data['count']);
 }
  }
  
  echo '</tbody>
        </table>';
		
		return $pieData;
}


//-----------------------------------------------------------------------------------------------
public function print_upload_form() {
?>
		
	<style>
			.btn-file {
			position: relative;
			overflow: hidden;
			margin:10px auto;
		}
		.btn-file input[type=file] {
			position: absolute;
			top: 0;
			right: 0;
			min-width: 100%;
			min-height: 100%;
			font-size: 100px;
			text-align: right;
			filter: alpha(opacity=0);
			opacity: 0;
			outline: none;
			background: white;'
			cursor: inherit;
			display: block;
		}
	</style>
		<div class="container">
	
  <div class="row" >
 <div class="col-sm-12" >
      <h2><p><b> Форма для завантаження файлів </b></p></h2>
      <form action="index.php?action=dashboard" method="post" enctype="multipart/form-data">
	  
	   <span class="btn btn-default btn-file" align=center>
     Обрати файл <input type="file"   name="filename" ><br> 
	    </span>
		
		

	  
      <input type="submit" class="btn btn-secondary btn-lg btn-block" value="Завантажити"><br>
	  
      </form>
	</div>
	</div></div>
	
<?php	 

}


//-----------------------------------------------------------------------------------------------
public function print_dashboard() {
	
  echo '<div class="container">';
	
  echo '<div class="row" >';
  echo '<div class="col-sm-12" >';
  $data_array = $this->model->getErrorCodes();
						
		  foreach ($data_array as $data){

		   $code_id = $data['code_id'];
		   $s_desc = $data['short_describtion'];
		   $desc = $data['describtion'];
		   echo '<div id="'. $code_id . '" class="collapse" >';
		   echo '<div class="alert alert-info" role="alert">';
		   echo '<h2>' . $code_id . '</h2>';
		   echo '<h3>' . $s_desc . '</h3>';
		   echo $desc;
		   
		   echo '</div>';
		   echo '</div>';
			
		  }
   echo '</div>';
   
  echo '<div class="col-sm-6">';
	  echo '<h2>Answer code statistic<h2>';
	  $answer_code_data = $this->print_stats("answer_code", true);
	  $this->draw_pie_chart("answer_code",$answer_code_data,"Chart2");
	  
		  
  	  echo '<h2>IP addresses statistic<h2>';
	  $ip_address_data = $this->print_stats("ip_address");
	  $this->draw_pie_chart("ip_address",$ip_address_data,"Chart1");
  echo '</div>';
  
  
  echo '<div class="col-sm-6">';
      echo '<h2>Date statistic<h2>';
	  $date_data = $this->print_stats("date");
	  $this->draw_pie_chart("date",$date_data,"Chart2");
	  
  
	   echo '<h2>Methods statistic<h2>';
	  $method_data = $this->print_stats("method");
	  $this->draw_pie_chart("method",$method_data,"Chart1");
	  echo '</div>';
  echo '</div>';


    $qr_result = $this->model->getLogs();

  echo '<table class="table table-condensed">
  <thead>
  <tr>
	<th>id</th>
	<th>http_version</th>
	<th>answer_code</th>
	<th>ip_address</th>
	<th>date</th>
	<th>time</th>
	<th>method</th>
	<th>file_name</th>
  </tr>
  </thead>
  <tbody>';
    
  foreach($qr_result as $data){ 
    echo '<tr>
    <td>' . $data['id'] . '</td>
	<td>' . $data['http_version'] . '</td>
    <td>' . $data['answer_code'] . '</td>
    <td>' . $data['ip_address'] . '</td>
    <td>' . $data['date'] . '</td>
	<td>' . $data['time'] . '</td>
    <td>' . $data['method'] . '</td>
    <td>' . $data['file_name'] . '</td>
	</tr>';
  }
  
  echo '</tbody>
        </table>';

		echo '</div>';
	
}
  
  }

?>